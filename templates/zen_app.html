<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surasura - Zen Mode</title>
    <style>
        :root {
            --bg: #000000;
            --fg: #e0e0e0;
            --dim: #666666;
            --accent: #ffffff;
            --prio-high: #ffd700;
            --prio-lop: #03dac6;
        }

        body {
            background-color: var(--bg);
            color: var(--fg);
            font-family: 'Courier New', Courier, monospace;
            /* Minimalist / Terminal feel */
            margin: 0;
            padding: 0;
            overflow-y: scroll;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* Centered Container */
        .container {
            width: 100%;
            max-width: 560px;
            /* Reduced by 20% from 700px */
            padding: 40px 20px;
            box-sizing: border-box;
        }

        /* --- Header / Logo --- */
        .zen-header {
            text-align: center;
            padding: 15px 0;
            background: #000;
            /* Solid-ish background for stickiness */
            backdrop-filter: blur(5px);
            border-bottom: 1px solid #222;
            position: sticky;
            top: 0;
            z-index: 1000;
            margin-bottom: 20px;

            opacity: 1;
            /* Keep container opacity 1 for background */
            /* filter: grayscale(100%);  <-- Moving this to children */
            transition: all 0.4s;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Apply dimming to children so background stays black */
        .zen-header>* {
            opacity: 0.2;
            filter: grayscale(100%);
            transition: all 0.4s;
        }

        .zen-header:hover>* {
            opacity: 1;
            filter: grayscale(0%);
        }

        .zen-header h1 {
            font-size: 1.5rem;
            margin: 0;
            margin-left: 10px;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: normal;
        }

        /* --- Progress Bar (Detailed) --- */
        .comprehension-stats {
            background: #111;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 30px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            text-align: left;
        }

        .header-stats {
            /* Wrapper adjustments */
            margin-bottom: 20px;
            border: none;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: #ccc;
        }

        .progress-container {
            height: 10px;
            background: #222;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
            display: flex;
            width: 100%;
        }

        .progress-segment {
            height: 100%;
            transition: width 0.5s ease-out;
        }

        .segment-base {
            background: #4caf50;
            opacity: 0.3;
        }

        .segment-start {
            background: #4caf50;
            opacity: 0.6;
        }

        .segment-target {
            background: #4caf50;
        }

        .legend {
            display: flex;
            gap: 15px;
            font-size: 0.75rem;
            color: #666;
            margin-top: 5px;
            display: none;
            /* Hide Legend in Zen Mode for cleaner look */
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        /* --- Word List --- */
        .word-item {
            margin-bottom: 60px;
            /* Large spacing for focus */
            padding-bottom: 40px;
            border-bottom: 1px dashed #222;
        }

        .word-header {
            display: flex;
            align-items: baseline;
            gap: 15px;
            margin-bottom: 15px;
        }

        .word-main {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent);
        }

        /* Advanced Hiding: Reversed text in DOM, corrected visually by CSS */
        .reading {
            font-size: 1.2rem;
            color: var(--dim);
            pointer-events: none;
            user-select: none;
        }

        .reading::before {
            content: attr(data-content);
            unicode-bidi: bidi-override;
            direction: rtl;
        }

        .meta-info {
            margin-left: auto;
            font-size: 0.9rem;
            color: var(--dim);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* Priority Icons */
        .prio-icon {
            font-size: 1rem;
        }

        .prio-high {
            color: var(--prio-high);
        }

        .prio-lop {
            color: var(--prio-lop);
        }

        /* Contexts */
        .context-box {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #ccc;
        }

        .context-line {
            margin-bottom: 12px;
            display: block;
            margin-left: 20px;
            /* Clear Indentation */
            padding-left: 12px;
            border-left: 3px solid #444;
            /* Visible indicator */
        }

        .context-line em {
            color: #ffffff;
            /* Fully White */
            font-style: normal;
            text-decoration: underline;
            text-decoration-color: #555;
            text-underline-offset: 3px;
        }

        /* --- Key Functions Footer --- */
        .key-functions {
            margin-top: auto;
            padding-top: 40px;
            padding-bottom: 20px;
            width: 100%;
            max-width: 700px;
            text-align: center;
            color: #444;
            font-size: 0.8rem;
            border-top: 1px solid #222;
        }

        .key-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 5px;
        }

        kbd {
            background: #222;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            color: #888;
        }

        /* Utility */
        .hidden {
            display: none;
        }

        /* Extension avoidance */
        [migaku_ignore],
        [data-yomichan-ignore] {
            /* Marker classes/attributes */
        }

        /* Cursor Hiding */
        .no-select {
            user-select: none;
            cursor: default;
        }

        /* Help Icon */
        .help-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .help-icon {
            width: 40px;
            height: 40px;
            background: #111;
            color: #ccc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: help;
            transition: background 0.2s;
        }

        .help-icon:hover {
            background: #555;
            color: #fff;
        }

        .help-tooltip {
            position: absolute;
            bottom: 50px;
            right: 0;
            background: #222;
            border: 1px solid #444;
            padding: 15px;
            border-radius: 8px;
            width: 250px;
            display: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        .help-container:hover .help-tooltip {
            display: block;
        }

        .help-key-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #aaa;
        }

        /* Visual Offset for Extra Contexts */
        .context-box {
            margin-top: 15px;
            padding-left: 15px;
            border-left: 3px solid #333;
            /* Continuous vertical line */
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .context-line {
            display: block;
            color: #ccc;
            line-height: 1.5;
            border: none !important;
            /* Force removal of any inherited borders */
            margin: 0 !important;
            /* Remove margins that might separate lines */
            padding: 0;
        }

        /* Performance & Cursor */
        .word-item {
            content-visibility: auto;
            /* Huge performance win */
            contain-intrinsic-size: 1px 200px;
            /* Estimate height */
        }

        body,
        .word-main,
        .reading {
            cursor: default;
            /* Hide text cursor */
            user-select: none;
            /* Prevent selection */
        }

        .context-line {
            cursor: default;
            /* Keep arrow cursor even over text */
            user-select: text;
            /* Allow text selection */
        }

        /* Global Caret Hiding */
        * {
            caret-color: transparent;
            /* Hides the blinking text insertion cursor */
        }
    </style>

</head>

<body>
    <div id="app" class="container">
        <!-- Logo Header -->
        <div class="zen-header">
            <!-- Generator will replace h1 with logo+h1 if set -->
            <h1>Surasura List</h1>
        </div>

        <!-- Word List Container -->
        <div id="word-list">
            <!-- Items injected here -->
        </div>
    </div>
    <!-- Floating Help Icon -->
    <div class="help-container">
        <div class="help-icon">?</div>
        <div class="help-tooltip">
            <div class="help-key-row"><span>Next Word</span><span><kbd>Space</kbd>/ <kbd>→</kbd></span></div>
            <div class="help-key-row"><span>Prev Word</span><span><kbd>←</kbd></span></div>
            <div class="help-key-row"><span>Scroll</span><span><kbd>j</kbd>/ <kbd>k</kbd></span></div>
        </div>
    </div>
    <script>
        // Global Error Handler for Debugging (Zen Mode Black Screen)
        window.onerror = function (msg, url, lineNo, columnNo, error) {
            const container = document.body;
            const errorBox = document.createElement('div');
            errorBox.style.position = 'fixed';
            errorBox.style.top = '0';
            errorBox.style.left = '0';
            errorBox.style.width = '100%';
            errorBox.style.background = '#800';
            errorBox.style.color = '#fff';
            errorBox.style.padding = '20px';
            errorBox.style.zIndex = '9999';
            errorBox.style.fontFamily = 'monospace';
            errorBox.innerHTML = `<h3>Zen Mode Crash</h3><p>${msg}</p><p>Line: ${lineNo}</p>`;
            container.appendChild(errorBox);
            return false;
        };
    </script>
    <script>let globalData = null;
    </script>
    <script> // --- Core Logic ---

        function init() {
            if (!globalData) return;

            // Zen Mode flattens everything. 
            // We just take the first file in 'progressive' for now 
            // or concatenate them if multiple? 
            // Requirement says "The file name", implying focus on one or sequential.
            // Let's render everything sequentially but show headers for files.

            const container = document.getElementById('word-list');

            // For minimalist approach, let's just render the ALL words in order
            // But we need to update the top bar "File Name" based on scroll position maybe?
            // Or just list them with simple dividers.

            // Let's stick to the First incomplete file for "Zen Focus" 
            // or if completed, the next one.

            // Actually, usually users analyze 5-6 files.
            // Let's render all of them.

            // Calculate Total Words for Zen Limit visibility
            const totalWords = globalData.progressive.reduce((acc, file) => acc + file.words.length, 0);
            const headerH1 = document.querySelector('.zen-header h1');
            if (headerH1) {
                const countSpan = document.createElement('span');
                countSpan.style.fontSize = "0.8rem";
                countSpan.style.color = "#666";
                countSpan.style.marginLeft = "15px";
                countSpan.style.fontWeight = "normal";
                countSpan.innerText = `(${totalWords} words)`;
                headerH1.appendChild(countSpan);
            }

            renderAllFiles(container);

            // Setup Keyboard
            setupKeyboard();
        }

        function renderAllFiles(container) {
            const progressive = globalData.progressive || [];

            progressive.forEach(fileData => {
                // Create File Section Wrapper
                const sectionDiv = document.createElement('div');
                sectionDiv.className = "file-section-wrapper";
                sectionDiv.style.marginBottom = "80px";

                // File Header (Name + Divider)
                const headerDiv = document.createElement('div');
                headerDiv.style.textAlign = "left";
                headerDiv.style.marginBottom = "20px";
                headerDiv.style.borderBottom = "1px solid #333";
                headerDiv.style.paddingBottom = "10px";
                headerDiv.innerHTML = `<h2 style="color: #fff; font-size: 1.4rem; font-weight: bold; margin: 0;">${fileData.filename.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</h2>`;
                sectionDiv.appendChild(headerDiv);

                // --- Per-File Stats ---
                const stats = calculateFileStats(fileData.words);
                if (stats) {
                    const statsBar = createComprehensionBar(stats);
                    // Adjust style for inside-list
                    statsBar.style.marginBottom = "40px";
                    statsBar.style.border = "none";
                    statsBar.style.background = "transparent";
                    sectionDiv.appendChild(statsBar);
                }

                // Render Words
                fileData.words.forEach(word => {
                    sectionDiv.appendChild(createWordItem(word));
                });

                container.appendChild(sectionDiv);
            });
        }

        function createWordItem(data) {
            const el = document.createElement('div');
            el.className = 'word-item';

            const word = data.Word;
            const reading = data.Reading || "";
            // Parsing Block: Reverse reading and escape quotes for HTML attribute
            const reversedReading = reading.split('').reverse().join('').replace(/"/g, '&quot;');
            const freq = data["Occurrences (Global)"] || data.Occurrences || 0;

            // Priority Logic
            let prioIcon = "";
            const pm = (globalLogic && globalLogic.priority_markers) ? globalLogic.priority_markers : { priority_threshold: 0.5, priority_min: 3, lopsided_threshold: 0.8 };
            const high = parseInt(data["Count (High)"]) || 0;
            const low = parseInt(data["Count (Low)"]) || 0;

            if (freq > 0 && (high / freq) >= pm.lopsided_threshold) {
                prioIcon = `<span class="prio-icon prio-lop" title="Lopsided">⚖</span>`;
            } else if (freq >= pm.priority_min && ((high + low) / freq) >= pm.priority_threshold) {
                prioIcon = `<span class="prio-icon prio-high" title="High Leverage">✦</span>`;
            }

            // Context Formatting
            const formatContext = (ctx) => {
                if (!ctx) return "";
                const safeWord = word.replace(/[.*+?^${}()|[\\]\\]/g, '\\$&');
                const regex = new RegExp(safeWord, 'gi');
                return ctx.replace(regex, `<em>${word}</em>`);
            };

            const contexts = [];
            if (data["Context 1"]) contexts.push(data["Context 1"]);
            if (data["Context 2"]) contexts.push(data["Context 2"]);
            if (data["Context 3"]) contexts.push(data["Context 3"]);

            const contextHtml = contexts.map(c => `<span class="context-line">${formatContext(c)}</span>`).join("");

            el.innerHTML = `
                    <div class="word-header">
                        <span class="word-main no-select" migaku_ignore data-yomichan-ignore>${word}</span>
                        <span class="reading" migaku_ignore data-yomichan-ignore data-content="${reversedReading}"></span>
                        <div class="meta-info no-select" migaku_ignore data-yomichan-ignore>
                            ${prioIcon}
                            <span>Freq: ${freq}</span>
                        </div>
                    </div>
                    <div class="context-box">
                        ${contextHtml}
                    </div>
                `;

            return el;
        }

        // Removed updateHeaderStats as it's now per-file

        function calculateFileStats(words) {
            if (!words || !words.length) return null;
            const first = words[0];
            const last = words[words.length - 1];

            return {
                baseline: parseFloat(first["Baseline %"]) || 0,
                start: parseFloat(first["Current %"]) || 0,
                target: parseFloat(last["New %"]) || 0,
                known: last["Known Count"] || 0,
                total: last["Total Count"] || 0
            };
        }

        function createComprehensionBar(stats) {
            const el = document.createElement('div');
            el.className = 'comprehension-stats';

            const baseWidth = stats.baseline;
            const startWidth = stats.start - stats.baseline;
            const targetWidth = stats.target - stats.start;

            // Stats HTML (Below Bar)
            const fileGrowth = (stats.target - stats.start).toFixed(2);

            el.innerHTML = `
            <div class="stats-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                <span style="font-weight: bold; color: #fff; font-size: 1.1rem; letter-spacing: 1px;">Learning Growth</span>
                <span style="color: #fff; font-weight: bold; font-size: 1.1rem;">Target: ${stats.target.toFixed(2)}%</span>
            </div>
            <div class="progress-container" style="height: 6px; background: #222; margin-bottom: 8px;">
                <div class="progress-segment" style="width: ${baseWidth}%; background: #666; opacity: 0.3;"></div>
                <div class="progress-segment" style="width: ${startWidth}%; background: #888; opacity: 0.6;"></div>
                <div class="progress-segment" style="width: ${targetWidth}%; background: #aaa;"></div>
            </div>
            <div style="display: flex; gap: 15px; font-size: 0.85rem; color: #666;">
                <span>Base: ${stats.baseline.toFixed(1)}%</span>
                <span>Start: ${stats.start.toFixed(1)}%</span>
                <span style="margin-left:auto; color: #888;">(+${fileGrowth}%)</span>
            </div>`;
            return el;
        }

        function setupKeyboard() {
            document.addEventListener('keydown', (e) => {
                if (e.key === 'j') {
                    window.scrollBy({ top: 100, behavior: 'smooth' });
                }
                if (e.key === 'k') {
                    window.scrollBy({ top: -100, behavior: 'smooth' });
                }
                if (e.code === 'Space' || e.code === 'ArrowRight') {
                    e.preventDefault();
                    scrollToNextWord();
                }
                if (e.code === 'ArrowLeft') {
                    e.preventDefault();
                    scrollToPrevWord();
                }
            });
        }

        function getActiveWordIndex() {
            const words = document.querySelectorAll('.word-item');
            if (words.length === 0) return -1;

            const center = window.innerHeight / 2;
            let closestI = -1;
            let minDiff = Infinity;

            words.forEach((w, i) => {
                const rect = w.getBoundingClientRect();
                const diff = Math.abs(rect.top + (rect.height / 2) - center);
                if (diff < minDiff) {
                    minDiff = diff;
                    closestI = i;
                }
            });
            return closestI;
        }

        function scrollToNextWord() {
            const words = document.querySelectorAll('.word-item');
            const idx = getActiveWordIndex();
            if (idx !== -1 && idx < words.length - 1) {
                words[idx + 1].scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else if (words.length > 0 && idx === -1) {
                words[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function scrollToPrevWord() {
            const words = document.querySelectorAll('.word-item');
            const idx = getActiveWordIndex();
            if (idx > 0) {
                words[idx - 1].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Init on load
        window.addEventListener('DOMContentLoaded', init);

    </script>
</body>

</html>